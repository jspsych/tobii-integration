---
name: Release Python Package

'on':
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.1, 0.2.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

concurrency:
  group: release-python
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write # Required for trusted publishing to PyPI

jobs:
  release:
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Validate version format
        env:
          VERSION: ${{ inputs.version }}
        run: |
          PATTERN='^[0-9]+\.[0-9]+\.[0-9]+(-[a-z0-9.]+)?$'
          if [[ ! "$VERSION" =~ $PATTERN ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Use semantic versioning (e.g., 0.1.1, 1.0.0-alpha.1)"
            exit 1
          fi

      - name: Update version in pyproject.toml
        env:
          VERSION: ${{ inputs.version }}
        working-directory: python
        run: |
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          echo "Updated version to $VERSION"
          grep '^version = ' pyproject.toml

      - name: Build package
        working-directory: python
        run: |
          python -m build
          ls -lh dist/

      - name: Check package with twine
        working-directory: python
        run: twine check dist/*

      - name: Commit version bump
        env:
          VERSION: ${{ inputs.version }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add python/pyproject.toml
          if git diff --cached --quiet; then
            echo "Version already set to ${VERSION}, skipping commit"
          else
            git commit -m "chore(python): release v${VERSION}"
            git push
          fi

      - name: Create Git tag
        env:
          VERSION: ${{ inputs.version }}
        run: |
          git tag -a "python-v${VERSION}" -m "Python package v${VERSION}"
          git push origin "python-v${VERSION}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          PRERELEASE: ${{ inputs.prerelease }}
        run: |
          PRERELEASE_FLAG=""
          if [ "$PRERELEASE" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          gh release create "python-v${VERSION}" \
            --title "Python Package v${VERSION}" \
            --notes "$(cat <<EOF
          Python package release v${VERSION}

          ## Installation

          \`\`\`bash
          pip install jspsych-tobii==${VERSION}
          \`\`\`

          For more details, see the repository documentation.
          EOF
          )" $PRERELEASE_FLAG

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          packages-dir: python/dist/
          print-hash: true

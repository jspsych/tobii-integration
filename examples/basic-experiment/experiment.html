<!DOCTYPE html>
<html>
<head>
    <title>Basic Tobii Eye Tracking Experiment</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="../../packages/extension-tobii/dist/index.browser.min.js"></script>
    <script src="../../packages/plugin-tobii-user-position/dist/index.browser.min.js"></script>
    <script src="../../packages/plugin-tobii-calibration/dist/index.browser.min.js"></script>
    <script src="../../packages/plugin-tobii-validation/dist/index.browser.min.js"></script>

    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="../../packages/plugin-tobii-calibration/dist/styles.css" rel="stylesheet" type="text/css" />
    <link href="../../packages/plugin-tobii-validation/dist/styles.css" rel="stylesheet" type="text/css" />
</head>
<body>
</body>
<script>
    // Initialize jsPsych with Tobii extension
    const jsPsych = initJsPsych({
        extensions: [
            {
                type: jsPsychExtensionTobii,
                params: {
                    connection: {
                        url: 'ws://localhost:8080',
                        autoConnect: true,
                    },
                    data: {
                        includeRawSamples: true,
                        coordinateSystem: 'normalized',
                    },
                },
            },
        ],
        on_finish: function() {
            // Export data
            const allData = jsPsych.data.get().values();
            jsPsych.extensions.tobii.exportToCSV(allData, 'experiment_data.csv');
            jsPsych.data.displayData();
        }
    });

    // Create timeline
    const timeline = [];

    // Welcome screen
    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <h1>Welcome to the Eye Tracking Experiment</h1>
            <p>This experiment will calibrate the eye tracker and then show you some stimuli.</p>
            <p>Press any key to begin.</p>
        `,
    });

    // User position check
    timeline.push({
        type: jsPsychTobiiUserPosition,
        message: 'Please position yourself so both indicators are green',
        duration: null, // Manual continuation
        update_interval: 100,
        show_distance_feedback: true,
        show_position_feedback: true,
        button_text: 'Continue to Calibration',
        require_good_position: false, // Set to true to require good position
    });

    // Calibration
    timeline.push({
        type: jsPsychTobiiCalibration,
        calibration_points: 9,
        calibration_mode: 'click',
        point_size: 25,
        animation: 'shrink',
    });

    // Validation
    timeline.push({
        type: jsPsychTobiiValidation,
        validation_points: 9,
        show_feedback: true,
    });

    // Instructions
    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <h2>Instructions</h2>
            <p>You will see a series of words appear on the screen.</p>
            <p>Read each word carefully. Press the spacebar to continue to the next word.</p>
            <p>Press any key to start.</p>
        `,
    });

    // Experimental trials with eye tracking
    const words = ['APPLE', 'BANANA', 'CHERRY', 'ORANGE', 'GRAPE'];

    words.forEach((word, index) => {
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<div style="font-size: 48px;">${word}</div>`,
            choices: [' '],
            extensions: [
                {
                    type: jsPsychExtensionTobii,
                },
            ],
            on_load: function() {
                // Send marker when stimulus appears
                jsPsych.extensions.tobii.sendMarker({
                    label: 'stimulus_onset',
                    word: word,
                    trial: index,
                });
            },
        });

        // Inter-stimulus interval
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '+',
            choices: 'NO_KEYS',
            trial_duration: 500,
        });
    });

    // Thank you
    timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <h2>Thank you!</h2>
            <p>The experiment is complete.</p>
            <p>Press any key to finish and download your data.</p>
        `,
    });

    // Run experiment
    jsPsych.run(timeline);
</script>
</html>
